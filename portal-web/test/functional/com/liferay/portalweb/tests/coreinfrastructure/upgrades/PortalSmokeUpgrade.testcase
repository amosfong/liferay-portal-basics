@component-name = "portal-upgrades"
definition {

	property app.server.types = "jboss,tomcat,weblogic,wildfly";
	property ci.retries.disabled = "true";
	property database.types = "db2,mariadb,mysql,oracle,postgresql,sqlserver";
	property portal.release = "true";
	property portal.upstream = "true";
	property test.liferay.virtual.instance = "false";
	property test.run.type = "single";
	property testray.main.component.name = "Database Upgrade Framework";

	setUp {
		SignIn.signIn();

		SearchAdministration.executeReindex();
	}

	@priority = 4
	test ViewPortalSmokeArchive625 {
		property data.archive.type = "data-archive-portal";
		property database.types = "postgresql";
		property portal.version = "6.2.5";
		property test.assert.warning.exceptions = "true";

		ValidateSmokeUpgrade.viewUpgrade();
	}

	@description = "LPS-158183: This is a smoke test to directly upgrade from 6.1 to 7.4 version using DB Upgrade Tool."
	@priority = 4
	test ViewPortalSmokeArchiveAndValidateSchema6130 {
		property custom.properties = "feature.flag.LPS-157670=true";
		property data.archive.type = "data-archive-portal";
		property database.types = "oracle,mariadb,mysql,postgresql,db2";
		property portal.version = "6.1.30";
		property test.assert.warning.exceptions = "true";

		ValidateSmokeUpgrade.viewUpgrade();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.bare.enabled=true");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@priority = 5
	test ViewPortalSmokeArchiveAndValidateSchema7110 {
		property data.archive.type = "data-archive-portal";
		property portal.smoke.upgrades = "true";
		property portal.version = "7.1.10";
		property test.assert.warning.exceptions = "true";

		ValidateSmokeUpgrade.viewUpgrade();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.bare.enabled=true");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@priority = 5
	test ViewPortalSmokeArchiveAndValidateSchema7210 {
		property data.archive.type = "data-archive-portal";
		property portal.smoke.upgrades = "true";
		property portal.upstream = "true";
		property portal.version = "7.2.10";
		property test.assert.warning.exceptions = "true";
		property test.run.environment = "EE";

		ValidateSmokeUpgrade.viewUpgrade();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.bare.enabled=true");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@priority = 5
	test ViewPortalSmokeArchiveAndValidateSchema7310 {
		property data.archive.type = "data-archive-portal";
		property portal.smoke.upgrades = "true";
		property portal.version = "7.3.10";
		property test.assert.warning.exceptions = "true";
		property test.run.environment = "EE";

		ValidateSmokeUpgrade.viewUpgrade();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.bare.enabled=true");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@priority = 5
	test ViewPortalSmokeArchiveAndValidateSchema7413 {
		property data.archive.type = "data-archive-portal";
		property portal.acceptance = "true";
		property portal.smoke.upgrades = "true";
		property portal.version = "7.4.13";
		property test.assert.warning.exceptions = "true";
		property test.run.environment = "EE";

		ValidateSmokeUpgrade.viewUpgrade();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.bare.enabled=true");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@priority = 5
	test ViewPortalSmokeArchiveAndValidateSchema70106 {
		property data.archive.type = "data-archive-portal";
		property portal.acceptance = "true";
		property portal.smoke.upgrades = "true";
		property portal.upstream = "true";
		property portal.version = "7.0.10.6";
		property test.assert.warning.exceptions = "true";

		ValidateSmokeUpgrade.viewUpgrade();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.bare.enabled=true");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

	@description = "This is a use case for LPS-105035."
	@priority = 5
	test ViewPortalSmokeArchiveAndValidateSchema71103 {
		property data.archive.type = "data-archive-portal";
		property portal.smoke.upgrades = "true";
		property portal.version = "7.1.10.3";
		property test.assert.warning.exceptions = "true";

		ValidateSmokeUpgrade.viewUpgrade();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=upgraded -Ddatabase.schema.name=lportal");

		AntCommands.runCommand("build-test.xml", "rebuild-database -Ddatabase.bare.enabled=true");

		Portlet.startServer();

		Portlet.shutdownServer();

		AntCommands.runCommand("build-test.xml", "export-database-schema -Ddatabase.file.prefix=fresh -Ddatabase.schema.name=lportal");

		UpgradeSchema.validateSchemas(
			freshDBSchemaName = "lportal",
			upgradedDBSchemaName = "lportal");
	}

}