@component-name = "portal-upgrades"
definition {

	property app.server.types = "tomcat";
	property database.bare.enabled = "true";
	property database.types = "db2,mariadb,mysql,oracle,postgresql,sqlserver";
	property minimum.slave.ram = "24";
	property portal.release = "true";
	property portal.smoke.upgrades = "false";
	property portal.upstream = "true";
	property skip.start.app.server = "true";
	property test.liferay.virtual.instance = "false";
	property test.run.type = "single";
	property testcase.url = "file:///opt/dev/projects/github/liferay-portal/";
	property testray.main.component.name = "Database Upgrade Framework";

	setUp {
		Upgrade.startReleasedBundle();
	}

	@priority = 4
	test AutoUpgradeFromLatest7413Update {
		User.firstLoginUI(
			password = PropsUtil.get("default.admin.password"),
			specificURL = "http://localhost:8080",
			userEmailAddress = "test@liferay.com");

		WebContentNavigator.openWebContentAdmin(
			baseURL = "http://localhost:8080",
			siteURLKey = "guest");

		WebContentNavigator.gotoAddCP();

		PortletEntry.inputTitle(title = "WC WebContent Title");

		PortletEntry.publish();

		WebContent.viewTitle(webContentTitle = "WC WebContent Title");

		Upgrade.restoreOriginalBundleAndUpgrade();

		TestUtils.hardRefresh();

		ContentPages.viewFragmentImage(
			fragmentName = "image",
			id = "image-square",
			image = "tree");

		WebContentNavigator.openWebContentAdmin(
			baseURL = "http://localhost:8080",
			siteURLKey = "guest");

		WebContentNavigator.gotoEditCP(webContentTitle = "WC WebContent Title");
	}

	@priority = 4
	test AutoUpgradeFromLatest7413UpdateWithDBPartitionEnabled {
		property custom.properties = "virtual.hosts.valid.hosts=localhost,127.0.0.1,www.able.com";
		property database.types = "mysql";
		property liferay.online.properties = "true";
		property timeout.explicit.wait = "120";

		User.firstLoginUI(
			password = PropsUtil.get("default.admin.password"),
			specificURL = "http://localhost:8080",
			userEmailAddress = "test@liferay.com");

		PortalInstances.openVirtualInstancesAdmin(baseURL = "http://localhost:8080");

		PortalInstances.addCP(
			mailDomain = "www.able.com",
			virtualHost = "www.able.com",
			webId = "www.able.com");

		User.firstLoginUI(
			password = PropsUtil.get("default.admin.password"),
			specificURL = "http://www.able.com:8080",
			userEmailAddress = "test@www.able.com");

		Navigator.openSpecificURL(url = "http://www.able.com:8080");

		ProductMenu.gotoPortlet(
			category = "Content & Data",
			panel = "Site Administration",
			portlet = "Documents and Media");

		DMDocument.addCP(
			dmDocumentDescription = "DM Document Description",
			dmDocumentFile = "Document_1.doc",
			dmDocumentTitle = "DM Document Title");

		Upgrade.restoreOriginalBundleAndUpgrade();

		User.firstLoginUI(
			password = PropsUtil.get("default.admin.password"),
			specificURL = "http://www.able.com:8080",
			userEmailAddress = "test@www.able.com");

		TestUtils.hardRefresh();

		ContentPages.viewFragmentImage(
			fragmentName = "image",
			id = "image-square",
			image = "tree");

		Navigator.openSpecificURL(url = "http://www.able.com:8080");

		ProductMenu.gotoPortlet(
			category = "Content & Data",
			panel = "Site Administration",
			portlet = "Documents and Media");

		DMNavigator.gotoDocumentCP(dmDocumentTitle = "DM Document Title");

		DMDocument.viewCP(dmDocumentTitle = "DM Document Title");

		SQL.assertDatabaseCount(
			databaseFilter = "lpartition%",
			databaseSubstring = "lpartition",
			expectedCount = 1);
	}

	@priority = 4
	test AutoUpgradeFromLatest7413UpdateWithDBPartitionEnabledAndHeadlessAPI {
		property database.types = "mysql";
		property liferay.online.properties = "true";

		User.firstLoginPG(
			password = PropsUtil.get("default.admin.password"),
			userEmailAddress = "test@liferay.com",
			virtualHostsURL = "http://localhost:8080");

		HeadlessPortalInstanceAPI.addPortalInstance(
			domain = "www.able.com",
			portalInstanceId = "www.able.com",
			virtualHost = "www.able.com");

		User.firstLoginPG(
			password = PropsUtil.get("default.admin.password"),
			userEmailAddress = "test@www.able.com",
			virtualHostsURL = "http://www.able.com:8080");

		ProductMenu.gotoPortlet(
			category = "Content & Data",
			panel = "Site Administration",
			portlet = "Documents and Media");

		DMDocument.addCP(
			dmDocumentDescription = "DM Document Description",
			dmDocumentFile = "Document_1.doc",
			dmDocumentTitle = "DM Document Title");

		Upgrade.restoreOriginalBundleAndUpgrade();

		User.firstLoginPG(
			password = PropsUtil.get("default.admin.password"),
			userEmailAddress = "test@www.able.com",
			virtualHostsURL = "http://www.able.com:8080");

		TestUtils.hardRefresh();

		ContentPages.viewFragmentImage(
			fragmentName = "image",
			id = "image-square",
			image = "tree");

		ProductMenu.gotoPortlet(
			category = "Content & Data",
			panel = "Site Administration",
			portlet = "Documents and Media");

		DMNavigator.gotoDocumentCP(dmDocumentTitle = "DM Document Title");

		DMDocument.viewCP(dmDocumentTitle = "DM Document Title");

		SQL.assertDatabaseCount(
			databaseFilter = "lpartition%",
			databaseSubstring = "lpartition",
			expectedCount = 1);
	}

}