@component-name = "portal-content-management"
definition {

	property ci.retries.disabled = "true";
	property portal.release = "true";
	property portal.upstream = "true";
	property testray.main.component.name = "Categories";

	setUp {
		task ("Set up instance and sign in") {
			TestCase.setUpPortalInstance();

			User.firstLoginPG();
		}

		task ("Add a site via JSON") {
			HeadlessSite.addSite(siteName = "Test Site Name");
		}

		task ("Activate local live staging") {
			JSONStaging.enableLocalStaging(groupName = "Test Site Name");
		}

		task ("Add a display page template for Web Content Article and Basic Web Content") {
			JSONLayoutpagetemplate.addDisplayPageTemplateEntry(
				contentType = "Web Content Article",
				displayPageTemplateEntryName = "Display Page Name",
				groupName = "Test Site Name-staging",
				site = "false",
				subType = "Basic Web Content");
		}
	}

	tearDown {
		var testLiferayVirtualInstance = PropsUtil.get("test.liferay.virtual.instance");

		if (${testLiferayVirtualInstance} == "true") {
			PortalInstances.tearDownCP();
		}
		else {
			JSONGroup.deleteGroupByName(groupName = "Test Site Name");
		}
	}

	@description = "This is a test for LPS-133767. The user can bulk assign categories to display page template in staging site but cannot in live site."
	@priority = 4
	@uitest
	test BulkAssignCategoriesToDisplayPageTemplateInStagingSite {
		task ("Add a vocabulary") {
			JSONCategory.addVocabulary(
				groupName = "Test Site Name (Staging)",
				site = "false",
				title = "Vocabulary Name");
		}

		task ("Add three categories in vocabulary") {
			for (var n : list "1,2,3") {
				JSONCategory.addCategory(
					groupName = "Test Site Name (Staging)",
					site = "false",
					title = "Category Name ${n}",
					vocabularyName = "Vocabulary Name");
			}
		}

		task ("Add a display page template for Category") {
			JSONLayoutpagetemplate.addDisplayPageTemplateEntry(
				contentType = "Category",
				displayPageTemplateEntryName = "Category DPT",
				groupName = "Test Site Name-staging",
				site = "false");
		}

		task ("Add a Heading fragment to display Page Template") {
			DisplayPageTemplatesAdmin.openDisplayPagesAdmin(siteURLKey = "test-site-name-staging");

			DisplayPageTemplatesAdmin.gotoDisplayPage(displayPageName = "Category DPT");

			PageEditor.addFragment(
				collectionName = "Basic Components",
				fragmentName = "Heading");
		}

		task ("Map the Name field to editable field") {
			PageEditorMapping.mapEditableTextToField(
				field = "Name",
				fragmentName = "Heading",
				id = "element-text");

			PageEditor.publish();
		}

		task ("Navigate to the new vocabulary in Categories admin") {
			Category.openCategoriesAdmin(siteURLKey = "test-site-name-staging");

			Vocabulary.goToVocabulary(vocabularyName = "Vocabulary Name");
		}

		task ("Bulk assign all categories to the display page template via page icon") {
			PortletEntry.selectAll();

			Click(
				key_text = "page",
				locator1 = "ManagementBar#ANY_ICON");

			Category.selectDisplayPageTemplate(
				displayPageName = "Category DPT",
				displayPageTemplateType = "Specific");

			PortletEntry.save();
		}

		task ("View mapped content shown on associated display page template at view mode in staging site") {
			for (var n : list "1,2,3") {
				LexiconEntry.gotoEntryMenuItem(
					menuItem = "View Display Page",
					rowEntry = "Category Name ${n}");

				ControlMenu.viewHeaderTitle(headerTitle = "Category Name ${n}");

				AssertVisible(
					key_tab = "Staging",
					locator1 = "NavTab#ACTIVE_TAB_LINK");

				ContentPages.viewFragmentText(
					fragmentName = "heading",
					id = "element-text",
					text = "Category Name ${n}");

				Category.openCategoriesAdmin(siteURLKey = "test-site-name-staging");
			}
		}

		task ("Publish to Live") {
			Staging.openStagingAdmin(siteURLKey = "test-site-name-staging");

			Staging.publishCustomPublication();
		}

		task ("Navigate to the new vocabulary in Categories admin of live site") {
			Category.openCategoriesAdmin(siteURLKey = "test-site-name");

			Vocabulary.goToVocabulary(vocabularyName = "Vocabulary Name");
		}

		task ("View mapped content shown on associated display page template at view mode in live site") {
			for (var n : list "1,2,3") {
				LexiconEntry.gotoEntryMenuItem(
					menuItem = "View Display Page",
					rowEntry = "Category Name ${n}");

				ControlMenu.viewHeaderTitle(headerTitle = "Category Name ${n}");

				AssertVisible(
					key_tab = "Live",
					locator1 = "NavTab#ACTIVE_TAB_LINK");

				ContentPages.viewFragmentText(
					fragmentName = "heading",
					id = "element-text",
					text = "Category Name ${n}");

				Category.openCategoriesAdmin(siteURLKey = "test-site-name");
			}
		}

		task ("View cannot bulk assign categories to associated display page template in live site") {
			PortletEntry.selectAll();

			AssertElementPresent(
				key_title = "Assign Display Page Template",
				locator1 = "Button#ANY_TITLE_DISABLED");

			Click(locator1 = "ManagementBar#ELLIPSIS");

			AssertVisible(
				key_menuItem = "Assign Display Page Template",
				locator1 = "MenuItem#DISABLED_MENU_ITEM");
		}

		task ("Navigate to the new vocabulary in Categories admin of staging site") {
			Category.openCategoriesAdmin(siteURLKey = "test-site-name-staging");

			Vocabulary.goToVocabulary(vocabularyName = "Vocabulary Name");
		}

		task ("Select the first and second categories") {
			for (var n : list "1,2") {
				Check(
					key_tableEntry = "Category Name ${n}",
					locator1 = "LexiconTable#TABLE_ENTRY_CHECKBOX");
			}
		}

		task ("Bulk assign all categories to the Default via action") {
			Click(locator1 = "ManagementBar#ELLIPSIS");

			MenuItem.click(menuItem = "Assign Display Page Template");

			Category.selectDisplayPageTemplate(
				displayPageName = "No Default Display Page Template",
				displayPageTemplateType = "Default");

			PortletEntry.save();
		}

		task ("View the View Display Page action not shown in the first and second categories") {
			for (var n : list "1,2") {
				LexiconEntry.viewNoEntryMenuItem(
					menuItem = "View Display Page",
					rowEntry = "Category Name ${n}");
			}
		}

		task ("View mapped content of the third category shown on associated display page template at view mode in staging site") {
			LexiconEntry.gotoEntryMenuItem(
				menuItem = "View Display Page",
				rowEntry = "Category Name 3");

			ControlMenu.viewHeaderTitle(headerTitle = "Category Name 3");

			AssertVisible(
				key_tab = "Staging",
				locator1 = "NavTab#ACTIVE_TAB_LINK");

			ContentPages.viewFragmentText(
				fragmentName = "heading",
				id = "element-text",
				text = "Category Name 3");
		}

		task ("Publish to Live") {
			Staging.gotoPublishToLive();

			Staging.publishToLive();
		}

		task ("Navigate to the new vocabulary in Categories admin of live site") {
			Category.openCategoriesAdmin(siteURLKey = "test-site-name");

			Vocabulary.goToVocabulary(vocabularyName = "Vocabulary Name");
		}

		task ("View the View Display Page action not shown in the first and second categories") {
			for (var n : list "1,2") {
				LexiconEntry.viewNoEntryMenuItem(
					menuItem = "View Display Page",
					rowEntry = "Category Name ${n}");
			}
		}

		task ("View mapped content of the third category shown on associated display page template at view mode in live site") {
			LexiconEntry.gotoEntryMenuItem(
				menuItem = "View Display Page",
				rowEntry = "Category Name 3");

			ControlMenu.viewHeaderTitle(headerTitle = "Category Name 3");

			AssertVisible(
				key_tab = "Live",
				locator1 = "NavTab#ACTIVE_TAB_LINK");

			ContentPages.viewFragmentText(
				fragmentName = "heading",
				id = "element-text",
				text = "Category Name 3");
		}
	}

}